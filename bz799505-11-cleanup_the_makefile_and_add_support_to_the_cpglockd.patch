From 5df73c4e049f3cc4f808e435e3c52668db28ec5a Mon Sep 17 00:00:00 2001
From: Ryan McCabe <rmccabe@redhat.com>
Date: Mon, 23 Apr 2012 22:09:44 -0400
Subject: [PATCH] Cleanup the Makefile and add support to the cpglockd
 init script for options set in
 /etc/sysconfig/cpglockd

Signed-off-by: Ryan McCabe <rmccabe@redhat.com>
Reviewed-by: Lon Hohberger <lhh@redhat.com>
Reviewed-by: Fabio M. Di Nitto <fdinitto@redhat.com>
---
 rgmanager/init.d/Makefile                  |   19 ++++++-------------
 rgmanager/init.d/cpglockd.in               |    5 +++++
 rgmanager/init.d/cpglockd.init.defaults.in |    7 +++++++
 3 files changed, 18 insertions(+), 13 deletions(-)
 create mode 100644 rgmanager/init.d/cpglockd.init.defaults.in

diff --git a/rgmanager/init.d/Makefile b/rgmanager/init.d/Makefile
index 7346884..959ddb3 100644
--- a/rgmanager/init.d/Makefile
+++ b/rgmanager/init.d/Makefile
@@ -1,26 +1,19 @@
-TARGET1=rgmanager
-TARGET2=cpglockd
+TARGET=rgmanager cpglockd cpglockd.init.defaults
 
-INITDT=$(TARGET1) $(TARGET2)
+INITDT=rgmanager cpglockd
 
-all: $(TARGET1) $(TARGET2)
+all: $(TARGET)
 
 include ../../make/defines.mk
 include $(OBJDIR)/make/clean.mk
 include $(OBJDIR)/make/install.mk
 include $(OBJDIR)/make/uninstall.mk
 
-$(TARGET1): $(S)/$(TARGET1).in
-	cat $(S)/$(TARGET1).in | sed \
+%: $(S)/%.in
+	cat $^ | sed \
 		-e 's#@SBINDIR@#${sbindir}#g' \
 		-e 's#@INITDDIR@#${initddir}#g' \
-	> $(TARGET1)
-
-$(TARGET2): $(S)/$(TARGET2).in
-	cat $(S)/$(TARGET2).in | sed \
-		-e 's#@SBINDIR@#${sbindir}#g' \
-		-e 's#@INITDDIR@#${initddir}#g' \
-	> $(TARGET2)
+	> $@
 
 clean: generalclean
 
diff --git a/rgmanager/init.d/cpglockd.in b/rgmanager/init.d/cpglockd.in
index 9fbb43c..772e0e8 100644
--- a/rgmanager/init.d/cpglockd.in
+++ b/rgmanager/init.d/cpglockd.in
@@ -59,6 +59,9 @@ if [ -d /etc/default ]; then
 	[ -z "$LOCK_FILE" ] && LOCK_FILE="/var/lock/cpglockd"
 fi
 
+[ -z "$CPGLOCKD_WAIT_FOR_QUORUM" ] && CPGLOCKD_WAIT_FOR_QUORUM="yes"
+[ -z "$CPGLOCKD_WAIT_FOR_FENCE_JOIN" ] && CPGLOCKD_WAIT_FOR_FENCE_JOIN="yes"
+
 #
 # Stop cpglockd
 #
@@ -83,6 +86,8 @@ start)
 	# they also assume that init scripts will create
 	# required subdirectories for proper operations
 	mkdir -p /var/run/cluster
+	[ "$CPGLOCKD_WAIT_FOR_QUORUM" = "no" ] && CPGLOCKD_OPTS+=" -Q"
+	[ "$CPGLOCKD_WAIT_FOR_FENCE_JOIN" = "no" ] && CPGLOCKD_OPTS+=" -F"
 
 	if status $CPGLOCKD > /dev/null 2>&1; then
 		success
diff --git a/rgmanager/init.d/cpglockd.init.defaults.in b/rgmanager/init.d/cpglockd.init.defaults.in
new file mode 100644
index 0000000..29caf27
--- /dev/null
+++ b/rgmanager/init.d/cpglockd.init.defaults.in
@@ -0,0 +1,7 @@
+# CPGLOCKD_WAIT_FOR_QUORUM -- Wait for cluster quorum formation
+#     at startup.
+#CPGLOCKD_WAIT_FOR_QUORUM=yes
+#
+# CPGLOCKD_WAIT_FOR_FENCE_JOIN -- Wait for the current node to join the
+#     fence domain at startup.
+#CPGLOCKD_WAIT_FOR_FENCE_JOIN=yes
-- 
1.7.7.6

